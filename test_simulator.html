<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOAA3 æµ‹è¯•æ¨¡æ‹Ÿå™¨</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .time-card {
            flex: 1;
            min-width: 200px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .time-card h3 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        .time-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #212529;
        }
        
        .test-data-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .test-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .test-btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #e9ecef;
            color: #495057;
        }
        
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .test-btn.active-test {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .test-btn.test-1 { background: linear-gradient(135deg, #ffd89b, #19547b); }
        .test-btn.test-2 { background: linear-gradient(135deg, #a8caba, #5d4157); }
        .test-btn.test-3 { background: linear-gradient(135deg, #89f7fe, #66a6ff); }
        .test-btn.test-4 { background: linear-gradient(135deg, #f093fb, #f5576c); }
        
        .status-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .status-item {
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .log-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #6c757d;
            background: #f8f9fa;
        }
        
        .log-entry.info { border-left-color: #17a2b8; background: #d1ecf1; }
        .log-entry.success { border-left-color: #28a745; background: #d4edda; }
        .log-entry.warning { border-left-color: #ffc107; background: #fff3cd; }
        .log-entry.error { border-left-color: #dc3545; background: #f8d7da; }
        
        .api-response {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        input[type="datetime-local"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸŒ¤ï¸ NOAA3 å¤©æ°”æ¨¡å—æµ‹è¯•æ¨¡æ‹Ÿå™¨</h1>
        <p>æµ‹è¯•APIè°ƒç”¨ã€æ—¶é—´æ¨¡æ‹Ÿå’Œå¤©æ°”æ•°æ®å±•ç¤º</p>
    </div>
    
    <div class="control-panel">
        <h2>â° æ—¶é—´æ§åˆ¶</h2>
        <div class="time-display">
            <div class="time-card">
                <h3>å½“å‰çœŸå®æ—¶é—´</h3>
                <div class="time-value" id="real-time">--:--:--</div>
            </div>
            <div class="time-card">
                <h3>æ¨¡æ‹Ÿæ—¶é—´</h3>
                <div class="time-value" id="simulated-time-display">--:--:--</div>
                <input type="datetime-local" id="simulated-time" style="margin-top: 10px; width: 100%;">
                <button class="btn btn-primary" onclick="applySimulatedTime()" style="margin-top: 10px; width: 100%;">åº”ç”¨æ¨¡æ‹Ÿæ—¶é—´</button>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-primary" onclick="simulateAPICall()">æ‰‹åŠ¨è°ƒç”¨API</button>
            <button class="btn btn-success" onclick="resetSystem()">é‡ç½®ç³»ç»Ÿ</button>
        </div>
    </div>
    
    <div class="test-data-panel">
        <h2>ğŸ“Š æµ‹è¯•æ•°æ®é€‰æ‹©</h2>
        <div class="test-buttons">
            <button class="test-btn test-1" onclick="setTestData(1)">æ•°æ®1: æ™´å¤© (00:00-06:00)</button>
            <button class="test-btn test-2" onclick="setTestData(2)">æ•°æ®2: å¤šäº‘ (06:00-12:00)</button>
            <button class="test-btn test-3" onclick="setTestData(3)">æ•°æ®3: é›¨å¤© (12:00-18:00)</button>
            <button class="test-btn test-4" onclick="setTestData(4)">æ•°æ®4: é›ªå¤© (18:00-24:00)</button>
        </div>
        
        <div class="status-panel">
            <div class="status-item">
                <strong>å½“å‰æµ‹è¯•æ•°æ®:</strong> <span id="current-test-data">æœªé€‰æ‹©</span>
            </div>
            <div class="status-item">
                <strong>APIè°ƒç”¨çŠ¶æ€:</strong> <span id="api-status">ç­‰å¾…è°ƒç”¨</span>
            </div>
            <div class="status-item">
                <strong>CookieçŠ¶æ€:</strong> <span id="cookie-status">æœªè®¾ç½®</span>
            </div>
        </div>
    </div>
    
    <div class="log-panel">
        <h2>ğŸ“ ç³»ç»Ÿæ—¥å¿—</h2>
        <div id="log-container"></div>
    </div>
    
    <div class="api-response">
        <h2>ğŸ” APIå“åº”æ•°æ®</h2>
        <pre id="api-response-data">ç­‰å¾…APIè°ƒç”¨...</pre>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let simulatedTime = null;
        let currentTestData = null;
        let autoTimeAdvancement = null;
        
        // æµ‹è¯•æ•°æ®æ˜ å°„
        const testDataMap = {
            1: { name: 'æ™´å¤© (00:00-06:00)', file: 'test_data_1.json' },
            2: { name: 'å¤šäº‘ (06:00-12:00)', file: 'test_data_2.json' },
            3: { name: 'é›¨å¤© (12:00-18:00)', file: 'test_data_3.json' },
            4: { name: 'é›ªå¤© (18:00-24:00)', file: 'test_data_4.json' }
        };
        
        // åˆå§‹åŒ–
        function init() {
            updateRealTime();
            setInterval(updateRealTime, 1000);
            
            // è®¾ç½®é»˜è®¤æ—¶é—´ä¸ºå½“å‰æ—¶é—´
            const now = new Date();
            simulatedTime = new Date(now);
            updateSimulatedTimeDisplay();
            
            // è®¾ç½®datetime-localè¾“å…¥æ¡†çš„é»˜è®¤å€¼
            document.getElementById('simulated-time').value = formatDateTimeLocal(now);
            
            // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€æ¡æµ‹è¯•æ•°æ®
            setTimeout(() => {
                setTestData(1);
            }, 100);
            
            // å¯åŠ¨æ—¶é—´è‡ªåŠ¨æ¨è¿›ï¼ˆæ¯5ç§’æ¨è¿›1å°æ—¶ï¼‰
            startAutoTimeAdvancement();
            
            log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'info');
            updateStatus('å·²è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€æ¡æµ‹è¯•æ•°æ®');
        }
        
        // æ›´æ–°çœŸå®æ—¶é—´æ˜¾ç¤º
        function updateRealTime() {
            const now = new Date();
            document.getElementById('real-time').textContent = formatDateTime(now);
        }
        
        // æ›´æ–°æ¨¡æ‹Ÿæ—¶é—´æ˜¾ç¤º
        function updateSimulatedTimeDisplay() {
            if (simulatedTime) {
                document.getElementById('simulated-time-display').textContent = formatDateTime(simulatedTime);
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(date) {
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ç”¨äºdatetime-localè¾“å…¥
        function formatDateTimeLocal(date) {
            return date.getFullYear() + '-' + 
                   String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(date.getDate()).padStart(2, '0') + 'T' + 
                   String(date.getHours()).padStart(2, '0') + ':' + 
                   String(date.getMinutes()).padStart(2, '0');
        }
        
        // è®¾ç½®æµ‹è¯•æ•°æ®
        function setTestData(testId) {
            currentTestData = testId;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.test-btn').forEach(btn => btn.classList.remove('active-test'));
            document.getElementById(`test-btn-${testId}`).classList.add('active-test');
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            document.getElementById('current-test-data').textContent = testDataMap[testId].name;
            
            // æ›´æ–°æ—¶é—´æ˜¾ç¤ºä»¥åæ˜ å½“å‰æ—¶é—´æ®µ
            updateTimeForTestData(testId);
            
            log(`é€‰æ‹©äº†æµ‹è¯•æ•°æ®: ${testDataMap[testId].name} (ID: ${testId})`, 'info');
            updateStatus(`å·²é€‰æ‹©: ${testDataMap[testId].name} - æ—¶é—´å·²åŒæ­¥`);
            
            // ç«‹å³åŠ è½½ä¸€æ¬¡æ•°æ®
            simulateAPICall();
        }
        
        // æ ¹æ®æµ‹è¯•æ•°æ®æ›´æ–°å¯¹åº”çš„æ—¶é—´
        function updateTimeForTestData(testId) {
            if (!simulatedTime) simulatedTime = new Date();
            
            // æ ¹æ®æµ‹è¯•æ•°æ®IDè®¾ç½®ä¸åŒçš„æ—¶é—´æ®µ
            // æ•°æ®1: 00:00-06:00 (å‡Œæ™¨)
            // æ•°æ®2: 06:00-12:00 (ä¸Šåˆ) 
            // æ•°æ®3: 12:00-18:00 (ä¸‹åˆ)
            // æ•°æ®4: 18:00-24:00 (æ™šä¸Š)
            const baseTime = new Date(simulatedTime);
            baseTime.setHours((testId - 1) * 6, 0, 0, 0);
            
            // åªæ›´æ–°æ—¶é—´éƒ¨åˆ†ï¼Œä¿æŒæ—¥æœŸä¸å˜
            simulatedTime.setHours(baseTime.getHours(), baseTime.getMinutes(), baseTime.getSeconds());
            
            updateSimulatedTimeDisplay();
            document.getElementById('simulated-time').value = formatDateTimeLocal(simulatedTime);
            
            log(`æ—¶é—´å·²åŒæ­¥åˆ° ${testDataMap[testId].name} å¯¹åº”æ—¶é—´æ®µ: ${formatDateTime(simulatedTime)}`, 'info');
        }
        
        // å¯åŠ¨æ—¶é—´è‡ªåŠ¨æ¨è¿›
        function startAutoTimeAdvancement() {
            // æ¯5ç§’è‡ªåŠ¨æ¨è¿›1å°æ—¶
            autoTimeAdvancement = setInterval(() => {
                if (!simulatedTime) simulatedTime = new Date();
                
                // æ¨è¿›1å°æ—¶
                simulatedTime.setHours(simulatedTime.getHours() + 1);
                updateSimulatedTimeDisplay();
                document.getElementById('simulated-time').value = formatDateTimeLocal(simulatedTime);
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ¢åˆ°ä¸‹ä¸€æ¡æµ‹è¯•æ•°æ®
                checkDataSwitchNeeded();
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦APIè°ƒç”¨
                checkAPICallNeeded();
                
                log(`æ—¶é—´è‡ªåŠ¨æ¨è¿›1å°æ—¶: ${formatDateTime(simulatedTime)}`, 'info');
            }, 5000);
        }
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ¢åˆ°ä¸‹ä¸€æ¡æµ‹è¯•æ•°æ®
        function checkDataSwitchNeeded() {
            if (!simulatedTime) return;
            
            const currentHour = simulatedTime.getHours();
            let expectedDataId = 1;
            
            // æ ¹æ®æ—¶é—´æ®µç¡®å®šåº”è¯¥ä½¿ç”¨çš„æµ‹è¯•æ•°æ®
            if (currentHour >= 0 && currentHour < 6) {
                expectedDataId = 1; // å‡Œæ™¨ - æ™´å¤©
            } else if (currentHour >= 6 && currentHour < 12) {
                expectedDataId = 2; // ä¸Šåˆ - å¤šäº‘
            } else if (currentHour >= 12 && currentHour < 18) {
                expectedDataId = 3; // ä¸‹åˆ - é›¨å¤©
            } else {
                expectedDataId = 4; // æ™šä¸Š - é›ªå¤©
            }
            
            // å¦‚æœå½“å‰æ•°æ®ä¸æ—¶é—´æ®µä¸åŒ¹é…ï¼Œè‡ªåŠ¨åˆ‡æ¢
            if (currentTestData !== expectedDataId) {
                log(`æ—¶é—´æ®µå˜åŒ–ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ° ${testDataMap[expectedDataId].name}`, 'success');
                setTestData(expectedDataId);
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦APIè°ƒç”¨
        function checkAPICallNeeded() {
            // æ¯å°æ—¶åªè°ƒç”¨ä¸€æ¬¡APIï¼ˆæ¨¡æ‹ŸCookieæœºåˆ¶ï¼‰
            const lastCall = getCookie('last_api_call');
            if (lastCall) {
                const lastCallTime = new Date(parseInt(lastCall));
                const currentTime = new Date();
                const hoursDiff = (currentTime - lastCallTime) / (1000 * 60 * 60);
                
                if (hoursDiff < 1) {
                    return; // ä¸åˆ°1å°æ—¶ï¼Œä¸è°ƒç”¨
                }
            }
            
            // è¶…è¿‡1å°æ—¶ï¼Œè°ƒç”¨API
            simulateAPICall();
        }
        
        // åº”ç”¨æ¨¡æ‹Ÿæ—¶é—´
        function applySimulatedTime() {
            const timeInput = document.getElementById('simulated-time').value;
            if (timeInput) {
                simulatedTime = new Date(timeInput);
                updateSimulatedTimeDisplay();
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ¢æµ‹è¯•æ•°æ®
                checkDataSwitchNeeded();
                
                log(`åº”ç”¨æ¨¡æ‹Ÿæ—¶é—´: ${formatDateTime(simulatedTime)}`, 'success');
            }
        }
        
        // æ¨¡æ‹ŸAPIè°ƒç”¨
        async function simulateAPICall() {
            if (!currentTestData) {
                log('è¯·å…ˆé€‰æ‹©æµ‹è¯•æ•°æ®', 'warning');
                return;
            }
            
            updateStatus('æ­£åœ¨è°ƒç”¨API...');
            log('å¼€å§‹æ¨¡æ‹ŸAPIè°ƒç”¨', 'info');
            
            try {
                // è®¾ç½®Cookieï¼Œè®°å½•æœ€åä¸€æ¬¡è°ƒç”¨æ—¶é—´
                setCookie('last_api_call', Date.now().toString(), 1);
                
                // è°ƒç”¨æµ‹è¯•æœåŠ¡å™¨
                const response = await fetch(`/modules/MMM-NOAA3/test_server.js?test=${currentTestData}&time=${simulatedTime.getTime()}`);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const data = await response.json();
                
                // æ˜¾ç¤ºAPIå“åº”æ•°æ®
                document.getElementById('api-response-data').textContent = JSON.stringify(data, null, 2);
                
                updateStatus('APIè°ƒç”¨æˆåŠŸ');
                log('APIè°ƒç”¨æˆåŠŸï¼Œæ•°æ®å·²æ›´æ–°', 'success');
                log(`æ‹‰å–æ•°æ®: ${data.current.weather[0].description}ï¼Œæ¸©åº¦: ${data.current.temp}Â°C`, 'info');
                
                // æ›´æ–°CookieçŠ¶æ€æ˜¾ç¤º
                updateCookieStatus();
                
            } catch (error) {
                updateStatus('APIè°ƒç”¨å¤±è´¥');
                log(`APIè°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('api-response-data').textContent = `é”™è¯¯: ${error.message}`;
            }
        }
        
        // é‡ç½®ç³»ç»Ÿ
        function resetSystem() {
            simulatedTime = new Date();
            updateSimulatedTimeDisplay();
            document.getElementById('simulated-time').value = formatDateTimeLocal(simulatedTime);
            
            // æ¸…é™¤Cookie
            deleteCookie('last_api_call');
            updateCookieStatus();
            
            // é‡æ–°é€‰æ‹©ç¬¬ä¸€æ¡æ•°æ®
            setTestData(1);
            
            log('ç³»ç»Ÿå·²é‡ç½®', 'success');
            updateStatus('ç³»ç»Ÿå·²é‡ç½®');
        }
        
        // Cookieæ“ä½œå‡½æ•°
        function setCookie(name, value, hours) {
            const date = new Date();
            date.setTime(date.getTime() + (hours * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/`;
        }
        
        function getCookie(name) {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [cookieName, cookieValue] = cookie.trim().split('=');
                if (cookieName === name) {
                    return cookieValue;
                }
            }
            return null;
        }
        
        function deleteCookie(name) {
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
        }
        
        // æ›´æ–°CookieçŠ¶æ€æ˜¾ç¤º
        function updateCookieStatus() {
            const lastCall = getCookie('last_api_call');
            if (lastCall) {
                const lastCallTime = new Date(parseInt(lastCall));
                const status = `æœ€åè°ƒç”¨: ${formatDateTime(lastCallTime)}`;
                document.getElementById('cookie-status').textContent = status;
            } else {
                document.getElementById('cookie-status').textContent = 'æœªè®¾ç½®';
            }
        }
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // æ›´æ–°çŠ¶æ€å‡½æ•°
        function updateStatus(message) {
            document.getElementById('api-status').textContent = message;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>